<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello World</title>
  <style>* {padding: 0; margin: 0}</style>
</head>
  <script src="./libs/pixi.min.js"></script>
  <script src="./libs/helper_functions.js"></script>
<body>
  <script type="text/javascript">
    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }

    PIXI.utils.sayHello(type)


PIXI.SCALE_MODES.DEFAULT = PIXI.SCALE_MODES.NEAREST;

//Aliases
let Application = PIXI.Application,
    Container = PIXI.Container,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    Sprite = PIXI.Sprite,
    TextureCache = PIXI.utils.TextureCache,
    Graphics = PIXI.Graphics,
    Text = PIXI.Text,
    TextStyle = PIXI.TextStyle,
    Rectangle = PIXI.Rectangle;



//Create a Pixi Application
let app = new Application({width: 256, height: 256});

//Add the canvas that Pixi automatically created for you to the HTML document
document.body.appendChild(app.view);
app.renderer.view.style.position = "absolute";
app.renderer.view.style.display = "block";
app.renderer.autoResize = true;
app.renderer.resize(window.innerWidth, window.innerHeight);


// learningPixi-master/examples/images/cat.png
loader
  .add("images/BlueShip.png")
  .add("images/RedShip.png")
  .add("images/block1.png")
  .add("images/redlaser.png")
  .add("images/orangelaser.png")
  .load(setup);


let message;

const nBlocks = 41;
const maxBullets = 20;
const minFramesSinceLastShot1 = 20;
const minFramesSinceLastShot2 = 20;
const bulletSpeed = 20;
let ship1Shield = 100;
let ship2Shield = ship1Shield;
let lastShotFrame1 = 61;
let lastShotFrame2 = 61;
let wall1 = new Array(nBlocks);
let wall2 = new Array(nBlocks);
let wall3 = new Array(nBlocks);
let wall4 = new Array(nBlocks);
let bullets1 = new Array(maxBullets);
let nextBullet1 = 0; // next bullet sprite to be fired 
let bullets2 = new Array(maxBullets);
let nextBullet2 = 0; // next bullet sprite to be fired 

let sHeight = window.innerHeight;
let sWidth  = window.innerWidth;


var Keys = {};
var fireKey1 = false;
var fireKey2 = false;
window.onkeyup = function(e) { Keys[e.keyCode] = false; if (!e.ctrlKey) {fireKey1 = false}; if (!e.shiftKey) {fireKey2 = false} }
window.onkeydown = function(e) { Keys[e.keyCode] = true; if (e.ctrlKey) {fireKey1 = true}; if (e.shiftKey) {fireKey2 = true} }

//This `setup` function will run when the image has loaded
function setup() {
  // How high each pieace of wall will be, considering nBlocks blocks
  blockHeight = sHeight/(nBlocks-1); // 1 block less because one block will be offscreen  
  blockWidth  = blockHeight;   // blocks will be square for now

  // create walls
  populateWall(wall1, sWidth*0.5-blocWidth*1.5, 1);
  populateWall(wall2, sWidth*0.5-blockWidth*0.5, 1);
  populateWall(wall3, sWidth*0.5+blockWidth*1.5, 1);

  // create bullets
  for (var i = 0; i<maxBullets; i++) {
    let s = new Sprite(loader.resources["images/redlaser.png"].texture); 
    let scaleFact = (blockWidth*2)/s.width; 
    s.scale.x = scaleFact; 
    s.scale.y = scaleFact;
    s.active = false;
    s.visible = false;
    bullets1[i] = s;
    app.stage.addChild(bullets1[i]);
  }
  for (var i = 0; i<maxBullets; i++) {
    let s = new Sprite(loader.resources["images/orangelaser.png"].texture); 
    let scaleFact = (blockWidth*2)/s.width; 
    s.scale.x = scaleFact; 
    s.scale.y = scaleFact;
    s.active = false;
    s.visible = false;
    bullets2[i] = s;
    app.stage.addChild(bullets2[i]);
  }


  //Create the ships sprite
  ship1 = new Sprite(loader.resources["images/BlueShip.png"].texture);
	let scaleFact = (blockHeight*3)/ship1.height; 

	ship1.scale.x = scaleFact; 
	ship1.scale.y = scaleFact;
  
  ship2 = new Sprite(loader.resources["images/RedShip.png"].texture);
	ship2.scale.x = scaleFact; 
	ship2.scale.y = scaleFact;

  // position ships
  ship1.vx = 0;
  ship1.vy = 0;
  ship1.position.set(0, window.innerHeight / 2);

  ship2.vx = 0;
  ship2.vy = 0;
  ship2.position.set(window.innerWidth - ship2.width, window.innerHeight / 2);

  //Add ships to the stage
  app.stage.addChild(ship1);
  app.stage.addChild(ship2);

  app.ticker.add(delta => gameLoop(delta));

}

let state = play;

function gameLoop(delta){
  state(delta);
}


function play(delta) {
	// react to keyboard input ship1
	if (Keys[87]) {
		ship1.vy = -5;
	}
	if (Keys[83]) {
		ship1.vy = +5;
	}
	if (!Keys[87] && !Keys[83]) {
		ship1.vy = 0;
	}
	if (Keys[68]) {
		ship1.vx = +5;
	}
	if (Keys[65]) {
		ship1.vx = -5;
	}
	if (!Keys[65] && !Keys[68]) {
		ship1.vx = 0;
	}
	// react to keyboard input ship2
	if (Keys[38]) {
		ship2.vy = -5;
	}
	if (Keys[40]) {
		ship2.vy = +5;
	}
	if (!Keys[40] && !Keys[38]) {
		ship2.vy = 0;
	}
	if (Keys[39]) {
		ship2.vx = +5;
	}
	if (Keys[37]) {
		ship2.vx = -5;
	}
	if (!Keys[39] && !Keys[37]) {
		ship2.vx = 0;
	}

  // check if shot fired. 
  // only shoot after a number of frames after last shot
  lastShotFrame1++;
  //todo ... adjust for delta?
  if (fireKey1  && lastShotFrame1 > minFramesSinceLastShot1) {
    lastShotFrame1 = 0;
    fireShot(bullets1, 1);    
  }
  // same for ship 2 
  // only shoot after a number of frames after last shot
  lastShotFrame2++;
  //todo ... adjust for delta?
  if (fireKey2  && lastShotFrame2 > minFramesSinceLastShot2) {
    lastShotFrame2 = 0;
    fireShot(bullets2, 2);    
  }

  // move bullets1
  for (var i = 0; i<maxBullets; i++) {
    let b = bullets1[i]; // convenience
    if (b.visible) {
      b.x += b.vx * delta;
      b.y += b.vy * delta;
      // deactivate if exited screen 
      if (b.x > sWidth) {
        b.visible = false;
      }
      // check for collision with blocks
      for (var j = 0; j<nBlocks; j++) {
        if (wall1[j].visible) {
          if (hitTestRectangle(b, wall1[j])) {
            b.visible = false;
            wall1[j].visible = false;
            break;
          }
        }
        if (wall2[j].visible) {
          if (hitTestRectangle(b, wall2[j])) {
            b.visible = false;
            wall2[j].visible = false;
            break;
          }
        }
      } 
    }
  }

  // move bullets2
  for (var i = 0; i<maxBullets; i++) {
    let b = bullets2[i]; // convenience
    if (b.visible) {
      b.x += b.vx * delta;
      b.y += b.vy * delta;
      // deactivate if exited screen 
      if (b.x < 0) {
        b.visible = false;
      }
      // check for collision with blocks
      for (var j = 0; j<nBlocks; j++) {
        if (wall3[j].visible) {
          if (hitTestRectangle(b, wall3[j])) {
            b.visible = false;
            wall3[j].visible = false;
            break;
          }
        }
        if (wall4[j].visible) {
          if (hitTestRectangle(b, wall4[j])) {
            b.visible = false;
            wall4[j].visible = false;
            break;
          }
        }
      } 
    }
  }

  //Move ship 1 
  ship1.x += (ship1.vx)*delta;
  ship1.y += (ship1.vy)*delta;
  if (ship1.y < 0) {
    ship1.y = 0;
  }
  if (ship1.y > sHeight - ship1.height) {
    ship1.y = sHeight - ship1.height;
  }
  if (ship1.x < 0) {
    ship1.x = 0;
  }
  if (ship1.x > sWidth - ship1.width) {
    ship1.x = sWidth - ship1.width;
  }

  //Move ship 2 
  ship2.x += (ship2.vx)*delta;
  ship2.y += (ship2.vy)*delta;
  if (ship2.y < 0) {
    ship2.y = 0;
  }
  if (ship2.y > sHeight - ship2.height) {
    ship2.y = sHeight - ship2.height;
  }
  if (ship2.x < 0) {
    ship2.x = 0;
  }
  if (ship2.x > sWidth - ship2.width) {
    ship2.x = sWidth - ship2.width;
  }

  // move walls        
  for (var i = 0; i<nBlocks; i++) {
    wall1[i].x += wall1[i].vx * delta;
    wall2[i].x += wall2[i].vx * delta;
    wall1[i].y += wall1[i].vy * delta;
    wall2[i].y += wall2[i].vy * delta;
    if (wall1[i].y > sHeight) {
      wall1[i].y = -blockHeight; // reposition offscreen at top
    }
    if (wall2[i].y < -blockHeight) {
      wall2[i].y = sHeight;// + blockHeight; // reposition offscreen at top
    }
  }
  // move walls        
  for (var i = 0; i<nBlocks; i++) {
    wall3[i].x += wall3[i].vx * delta;
    wall4[i].x += wall4[i].vx * delta;
    wall3[i].y += wall3[i].vy * delta;
    wall4[i].y += wall4[i].vy * delta;
    if (wall3[i].y > sHeight) {
      wall3[i].y = -blockHeight; // reposition offscreen at top
    }
    if (wall4[i].y < -blockHeight) {
      wall4[i].y = sHeight;// + blockHeight; // reposition offscreen at top
    }
  }
}


  </script>
</body>
</html>

